// ==UserScript==
// @name         Fix BCS Grader
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  Fixing things in BCS Grader that should have been fixed long ago
// @author       Lee Morgan
// @match        https://grading.bootcampspot.com/*
// @icon         https://grading.bootcampspot.com/favicon.png
// @grant        none
// ==/UserScript==
(()=>{(function(){"use strict";let c={run:function(){this.getAssignmentData();let i=setInterval(()=>{document.querySelectorAll(".ui.header").length>0&&(clearInterval(i),this.addRubric(),this.addSaveAssignment())},100)},getAssignmentData:function(){let i=window.location.pathname.split("/");i=Number(i[i.length-1]),fetch("https://grading.bootcampspot.com/api/centralgrading/v1/submissionDetail",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:{id:1,name:"Central Grader"},submissionId:i})}).then(l=>l.json()).then(l=>{let e=setInterval(()=>{if(document.querySelectorAll(".ui.header").length>0){clearInterval(e);let t=document.querySelectorAll(".ui.comments .comment"),n=0,r=0;for(let a=0;a<l.data.length;a++)l.data[a].key==="Comment"&&(l.data[a].children[1].content==="Central Grader"&&(this.addGrade(l.relatedSubmissions[r].grade,t[n].querySelector(".metadata")),r++),this.rewriteText(t[n].querySelector(".text"),l.data[a].content),n++)}},100)}).catch(l=>{console.error(l)})},addGrade:function(i,l){let e=document.createElement("p");e.classList.add("gradeDisplay"),e.textContent=`Grade: ${i.grade} / 100`,l.appendChild(e)},addRubric:function(){let i=document.querySelector(".divided.equal.width.row"),l=i.querySelector("h2"),e=i.children[1].children[0].children[3],t=document.querySelector(".ui.segment.active.tab");l=Number(l.textContent.split(" ")[1]);let n=document.createElement("iframe");n.classList.add("rubricFrame"),n.src=`https://leemorgan.io/2u/rubrics/${l}`,n.style.height=`${t.clientHeight}px`,e.appendChild(n)},rewriteText:function(i,l){i.textContent="";let e=l.split(`
`);for(let t=0;t<e.length;t++){let n=document.createElement("p");n.textContent=e[t],i.appendChild(n)}},addSaveAssignment:function(){document.querySelector(".ui.green.icon.positive.right.labeled.button").addEventListener("click",()=>{let l=document.querySelector(".divided.equal.width.row").children[1].children[0].children[1],e=window.location.href.split("/");e=e[e.length-1];let t=l.children[0].innerText;t=t.split(" "),t=t[1];let n="",r=document.querySelectorAll(".ui.toggle.checkbox input");r[0].checked?n="plagiarism":r[1].checked?n="incomplete":n=document.querySelector(".gradeInputBoxForCanvas").children[0].value;let a=new Date;a=a.toISOString();let d=localStorage.getItem("graded");d=d||"",d+=`${e},${t},${n},${a}
`,localStorage.setItem("graded",d)})}},u={ungraded:[],waitingReview:[],pastDue:[],clonableAssCard:document.createElement("div"),run:function(){let i=null,l=null,e=document.createElement("div");this.clonableAssCard.innerHTML='<div style="padding: 10px; border: 1px solid rgb(222, 222, 223); border-radius: 5px;" class="item queue-item canvas"><div style="position: relative;" class="content"><a href="https://grading.bootcampspot.com/canvasSubmission/820697"><div style="font-size: 20px; font-weight: bold; color: black; width: 50%;" class="header">Module 21 Challenge</div></a><div style="display: flex; flex-direction: row-reverse; align-items: center;"><div style="margin-right: 10px; margin-top: -1.5em;"></div></div><div class="description"><div class="ui grid"><div class="six wide computer sixteen wide mobile six wide tablet column"><p>In Progress</p><p>2023-08-18T02:13:46.947976Z</p><p>2023-08-18T04:59:59Z</p><p>Full Stack Flex</p></div><div class="six wide computer sixteen wide mobile six wide tablet column"><p>Cotton, Gage</p><p>UTA-VIRT-FSF-PT-03-2023-U-LOLC-MWTH(A)</p></div></div></div><a style="bottom: 0px; right: 0px; position: absolute;" class="ui grey button" role="button" href="https://grading.bootcampspot.com/canvasSubmission/820697"><i class="right arrow icon"></i></a></div></div>',this.clonableAssCard=this.clonableAssCard.firstChild;let t=setInterval(()=>{try{l=document.querySelector(".ui.grid"),i=l.children[1]}catch{}if(i!==null){clearInterval(t),i.style.display="none",e=i.cloneNode(!0);let n=e.querySelector(".ui.secondary.menu");for(let r=0;r<n.children.length;r++)n.children[r].addEventListener("click",()=>{for(let d=0;d<n.children.length;d++)n.children[d].classList.remove("active");let a=[];switch(r){case 0:a=this.ungraded;break;case 1:a=this.pastDue;break;case 2:a=this.waitingReview;break}n.children[r].classList.add("active"),this.displayAssignments(a,e)});e.style.display="block",l.appendChild(e),this.getClaimed(e)}},100)},getClaimed:function(i){let l=[];for(let e=0;e<2;e++){let t=fetch("https://grading.bootcampspot.com/api/centralgrading/v1/myClaimedSubmissions",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({offset:e*10,resultsPerPage:500,role:{id:1,name:"Central Grader"}})});l.push(t)}Promise.all(l).then(e=>Promise.all(e.map(t=>t.json()))).then(e=>{this.ungraded=[],this.waitingReview=[],this.pastDue=[];let t=[];for(let n=0;n<e.length;n++)t=t.concat(e[n].data);t=t.filter((n,r,a)=>r===a.findIndex(d=>d.id===n.id));for(let n=0;n<t.length;n++){let r=t[n].status;r==="In Progress"?this.ungraded.push(t[n]):r==="Ready for Review"||r==="Flagged"?this.waitingReview.push(t[n]):this.pastDue.push(t[n])}this.displayAssignments(this.ungraded,i)}).catch(e=>{console.error(e)})},displayAssignments:function(i,l){let e=l.querySelector(".ui.items");for(;e.children.length>0;)e.removeChild(e.lastChild);for(let t=0;t<i.length;t++){let n=this.createAssCard(i[t]);e.appendChild(n)}try{document.querySelector(".ui.pagination.menu").style.display="none"}catch{}},createAssCard:function(i){let l=this.clonableAssCard.cloneNode(!0),e=l.querySelector(".header");e.textContent=i.assignmentName,e.parentElement.href=`https://grading.bootcampspot.com/canvasSubmission/${i.id}`;let t=l.querySelector(".description > .ui.grid").children[0];t.children[0].textContent=i.status,t.children[1].textContent=i.date,t.children[2].textContent=i.assignmentDueDate,t.children[3].textContent=i.program.name;let n=l.querySelector(".description > .ui.grid").children[1];return n.children[0].textContent=i.studentName,n.children[1].textContent=i.course.name,l.querySelector(".ui.grey.button").href=`https://grading.bootcampspot.com/canvasSubmission/${i.id}`,l}};(()=>{let i=window.location.href,l=()=>{let r=`
.gradeDisplay{color: green;font-weight: bold;} .rubricFrame{width: 100%;} .rubricFrame span{font-size: 12px;} #downloadGraded{height: 50%;background: green;border: none;z-index: 999;cursor: pointer;color: white;padding: 5px;margin: auto 0;box-shadow: 0 0 5px black;} .column > .ui.container{width: 90%;}.ui.container.stackable.grid{width: 90% !important;} #root .ten.wide.column{width: 700px !important;padding-left: 0;} .divided.equal.width.row > column{padding-right: 0;}
`,a=document.createElement("style");a.textContent=r,document.body.appendChild(a)},e=()=>{let r=document.createElement("button");r.textContent="Download Graded",r.id="downloadGraded";let a=document.querySelector(".ui.top.fixed.menu").children[0];a.insertBefore(r,a.children[1]),r.addEventListener("click",()=>{let d=`urlId,module,grade,timestamp
`,o=localStorage.getItem("graded");o=o||"";let h=new Blob([d,o]),s=document.createElement("a"),m=URL.createObjectURL(h);s.href=m,s.download="gradedAssignments.csv",document.body.appendChild(s),s.click()})},t=()=>{i.includes("canvasSubmission")&&c.run(),i.includes("claimed")&&u.run()};setInterval(()=>{let r=window.location.href;r!==i&&(i=r,t())},250);let n=setInterval(()=>{try{document.querySelector(".ui.top.fixed.menu"),clearInterval(n),e()}catch{}},100);t(),l()})()})();})();
