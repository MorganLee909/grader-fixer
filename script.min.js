// ==UserScript==
// @name         Fix BCS Grader
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Fixing things in BCS Grader that should have been fixed long ago
// @author       Lee Morgan
// @match        https://grading.bootcampspot.com/*
// @icon         https://grading.bootcampspot.com/favicon.png
// @grant        none
// ==/UserScript==
(()=>{(function(){"use strict";let u={run:function(){this.getAssignmentData();let n=setInterval(()=>{document.querySelectorAll(".ui.header").length>0&&(clearInterval(n),this.addRubric(),this.addSaveAssignment())},100)},getAssignmentData:function(){let n=window.location.pathname.split("/");n=Number(n[n.length-1]),fetch("https://grading.bootcampspot.com/api/centralgrading/v1/submissionDetail",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:{id:1,name:"Central Grader"},submissionId:n})}).then(i=>i.json()).then(i=>{let e=setInterval(()=>{if(document.querySelectorAll(".ui.header").length>0){clearInterval(e);let t=document.querySelectorAll(".ui.comments .comment"),l=0,a=0;for(let r=0;r<i.data.length;r++)i.data[r].key==="Comment"&&(i.data[r].children[1].content==="Central Grader"&&(this.addGrade(i.relatedSubmissions[a].grade,t[l].querySelector(".metadata")),a++),this.rewriteText(t[l].querySelector(".text"),i.data[r].content),l++)}},100)}).catch(i=>{console.error(i)})},addGrade:function(n,i){let e=document.createElement("p");e.classList.add("gradeDisplay"),e.textContent=`Grade: ${n.grade} / 100`,i.appendChild(e)},addRubric:function(){let n=document.querySelector(".divided.equal.width.row"),i=n.querySelector("h2"),e=n.children[1].children[0].children[3],t=document.querySelector(".ui.segment.active.tab");i=Number(i.textContent.split(" ")[1]);let l=document.createElement("iframe");l.classList.add("rubricFrame"),l.src=`https://leemorgan.io/2u/rubrics/${i}`,l.style.height=`${t.clientHeight}px`,e.appendChild(l)},rewriteText:function(n,i){n.textContent="";let e=i.split(`
`);for(let t=0;t<e.length;t++){let l=document.createElement("p");l.textContent=e[t],n.appendChild(l)}},addSaveAssignment:function(){document.querySelector(".ui.green.icon.positive.right.labeled.button").addEventListener("click",()=>{let i=document.querySelector(".divided.equal.width.row").children[1].children[0].children[1],e=window.location.href.split("/");e=e[e.length-1];let t=i.children[0].innerText;t=t.split(" "),t=t[1];let l="",a=document.querySelectorAll(".ui.toggle.checkbox input");a[0].checked?l="plagiarism":a[1].checked?l="incomplete":l=document.querySelector(".gradeInputBoxForCanvas").children[0].value;let r=new Date;r=r.toISOString();let d=localStorage.getItem("graded");d=d||"",d+=`${e},${t},${l},${r}
`,localStorage.setItem("graded",d)})}},h={ungraded:[],waitingReview:[],pastDue:[],clonableAssCard:document.createElement("div"),run:function(){let n=null,i=null,e=document.createElement("div");this.clonableAssCard.innerHTML='<div style="padding: 10px; border: 1px solid rgb(222, 222, 223); border-radius: 5px;" class="item queue-item canvas"><div style="position: relative;" class="content"><a href="https://grading.bootcampspot.com/canvasSubmission/820697"><div style="font-size: 20px; font-weight: bold; color: black; width: 50%;" class="header">Module 21 Challenge</div></a><div style="display: flex; flex-direction: row-reverse; align-items: center;"><div style="margin-right: 10px; margin-top: -1.5em;"></div></div><div class="description"><div class="ui grid"><div class="six wide computer sixteen wide mobile six wide tablet column"><p>In Progress</p><p>2023-08-18T02:13:46.947976Z</p><p>2023-08-18T04:59:59Z</p><p>Full Stack Flex</p></div><div class="six wide computer sixteen wide mobile six wide tablet column"><p>Cotton, Gage</p><p>UTA-VIRT-FSF-PT-03-2023-U-LOLC-MWTH(A)</p></div></div></div><a style="bottom: 0px; right: 0px; position: absolute;" class="ui grey button" role="button" href="https://grading.bootcampspot.com/canvasSubmission/820697"><i class="right arrow icon"></i></a></div></div>',this.clonableAssCard=this.clonableAssCard.firstChild;let t=setInterval(()=>{try{i=document.querySelector(".ui.grid"),n=i.children[1]}catch{}if(n!==null){clearInterval(t),n.style.display="none",e=n.cloneNode(!0);let l=e.querySelector(".ui.secondary.menu");for(let a=0;a<l.children.length;a++)l.children[a].addEventListener("click",()=>{for(let d=0;d<l.children.length;d++)l.children[d].classList.remove("active");let r=[];switch(a){case 0:r=this.ungraded;break;case 1:r=this.pastDue;break;case 2:r=this.waitingReview;break}l.children[a].classList.add("active"),this.displayAssignments(r,e)});e.style.display="block",i.appendChild(e),this.getClaimed(e)}},100)},getClaimed:function(n){let i=[];for(let e=0;e<1;e++){let t=fetch("https://grading.bootcampspot.com/api/centralgrading/v1/myClaimedSubmissions",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({offset:e*10,resultsPerPage:500,role:{id:1,name:"Central Grader"}})});i.push(t)}Promise.all(i).then(e=>Promise.all(e.map(t=>t.json()))).then(e=>{this.ungraded=[],this.waitingReview=[],this.pastDue=[];let t=[];for(let r=0;r<e.length;r++)t=t.concat(e[r].data);t=t.filter((r,d,o)=>d===o.findIndex(c=>c.id===r.id));for(let r=0;r<t.length;r++){let d=t[r].status;d==="In Progress"?this.ungraded.push(t[r]):d==="Ready for Review"||d==="Flagged"?this.waitingReview.push(t[r]):this.pastDue.push(t[r])}let l=n.querySelector(".ui.secondary.menu");l.children[0].textContent=`Active (${this.ungraded.length})`,l.children[1].textContent=`Past Due (${this.pastDue.length})`,l.children[2].textContent=`Waiting for review (${this.waitingReview.length})`;let a=this.ungraded.length+this.pastDue.length+this.waitingReview.length;document.querySelector(".ui.header small em").textContent=`${a} results`,this.displayAssignments(this.ungraded,n)}).catch(e=>{console.error(e)})},displayAssignments:function(n,i){let e=i.querySelector(".ui.items");for(;e.children.length>0;)e.removeChild(e.lastChild);for(let t=0;t<n.length;t++){let l=this.createAssCard(n[t]);e.appendChild(l)}try{document.querySelector(".ui.pagination.menu").style.display="none"}catch{}},createAssCard:function(n){let i=this.clonableAssCard.cloneNode(!0),e=i.querySelector(".header");e.textContent=n.assignmentName,e.parentElement.href=`https://grading.bootcampspot.com/canvasSubmission/${n.id}`;let t=i.querySelector(".description > .ui.grid").children[0];t.children[0].textContent=n.status,t.children[1].textContent=n.date,t.children[2].textContent=n.assignmentDueDate,t.children[3].textContent=n.program.name;let l=i.querySelector(".description > .ui.grid").children[1];return l.children[0].textContent=n.studentName,l.children[1].textContent=n.course.name,i.querySelector(".ui.grey.button").href=`https://grading.bootcampspot.com/canvasSubmission/${n.id}`,i}};(()=>{let n=window.location.href,i=()=>{let a=`
.gradeDisplay{color: green;font-weight: bold;} .rubricFrame{width: 100%;} .rubricFrame span{font-size: 12px;} #downloadGraded{height: 50%;background: green;border: none;z-index: 999;cursor: pointer;color: white;padding: 5px;margin: auto 0;box-shadow: 0 0 5px black;} .column > .ui.container{width: 90%;} .ui.container.stackable.grid{width: 90% !important;} #root .ten.wide.column{width: 700px !important;padding-left: 0;} .divided.equal.width.row > column{padding-right: 0;}`,r=document.createElement("style");r.textContent=a,document.body.appendChild(r)},e=()=>{let a=document.createElement("button");a.textContent="Download Graded",a.id="downloadGraded";let r=document.querySelector(".ui.top.fixed.menu").children[0];r.insertBefore(a,r.children[1]),a.addEventListener("click",()=>{let d=`urlId,module,grade,timestamp
`,o=localStorage.getItem("graded");o=o||"";let c=new Blob([d,o]),s=document.createElement("a"),m=URL.createObjectURL(c);s.href=m,s.download="gradedAssignments.csv",document.body.appendChild(s),s.click()})},t=()=>{n.includes("canvasSubmission")&&u.run(),n.includes("claimed")&&h.run()};setInterval(()=>{let a=window.location.href;a!==n&&(n=a,t())},250);let l=setInterval(()=>{try{document.querySelector(".ui.top.fixed.menu"),clearInterval(l),e()}catch{}},100);t(),i()})()})();})();
